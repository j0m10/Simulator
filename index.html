<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLC Simulator - Diagnostic Mode</title>
    <style>
        :root {
            --bg: #1e1e1e;
            --panel: #2d2d2d;
            --text: #e0e0e0;
            --accent: #2196F3;
            --green: #4CAF50;
            --wire: #757575;
            --active: #00E676;
        }

        body {
            font-family: 'Segoe UI', monospace;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* TOOLBAR */
        header {
            background: var(--panel);
            padding: 10px;
            border-bottom: 1px solid #444;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background: #444;
            color: white;
            border: 1px solid #555;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover { background: #555; }
        button.active { background: var(--accent); border-color: var(--accent); }
        button.run { background: var(--green); border-color: var(--green); }
        button.stop { background: #f44336; border-color: #d32f2f; }

        /* LAYOUT */
        .main { display: flex; flex: 1; overflow: hidden; }
        
        .sidebar {
            width: 200px;
            background: #252526;
            border-right: 1px solid #333;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .tool-btn {
            padding: 10px;
            background: #333;
            border: 1px solid #444;
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
        }
        .tool-btn:hover { background: #444; }
        .tool-btn.selected { border-color: var(--accent); background: #2b3a42; }

        .workspace {
            flex: 1;
            padding: 20px;
            overflow: auto;
            position: relative;
        }

        /* DIAGNOSTIC CONSOLE */
        #debugConsole {
            height: 120px;
            background: #111;
            border-top: 2px solid #444;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            overflow-y: auto;
            color: #aaa;
        }
        .log-err { color: #ff5555; }
        .log-info { color: #88ccff; }

        /* GRID */
        .rung { display: flex; margin-bottom: 10px; height: 60px; }
        .cell {
            width: 80px; height: 100%;
            position: relative;
            border-bottom: 1px dashed #333;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .cell:hover { background: #333; }
        
        /* VISUALS */
        .wire-h { position: absolute; width: 100%; height: 2px; background: var(--wire); top: 50%; z-index: 1; }
        .symbol {
            width: 40px; height: 40px; background: var(--bg); z-index: 2; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .tag-lbl { position: absolute; top: -15px; font-size: 0.7rem; color: #888; white-space: nowrap; }

        /* Active States */
        .powered .wire-h { background: var(--active); box-shadow: 0 0 5px var(--active); }
        .powered .symbol { border-color: var(--active); }
        .on-coil { background: rgba(0, 230, 118, 0.3); border-radius: 50%; }

        /* Modal */
        #modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center;
        }
        .modal-box { background: #333; padding: 20px; width: 300px; border-radius: 5px; }
        input { width: 100%; padding: 8px; margin: 10px 0; background: #222; border: 1px solid #555; color: white; }

    </style>
</head>
<body>

    <header>
        <strong>PLC DIAGNOSTIC</strong>
        <button id="btnEdit" class="active" onclick="setMode('edit')">EDIT</button>
        <button id="btnRun" class="run" onclick="setMode('run')">RUN</button>
        <button onclick="clearProg()">Clear</button>
    </header>

    <div class="main">
        <div class="sidebar">
            <div class="tool-btn selected" id="t-XIC" onclick="setTool('XIC')">XIC -| |-</div>
            <div class="tool-btn" id="t-XIO" onclick="setTool('XIO')">XIO -|/|-</div>
            <div class="tool-btn" id="t-OTE" onclick="setTool('OTE')">OTE -( )</div>
            <div class="tool-btn" id="t-DEL" onclick="setTool('DELETE')" style="color:#f55">Delete</div>
            <hr style="width:100%; border:0; border-top:1px solid #444;">
            <div style="font-size:0.8rem; color:#aaa;">Data Table:</div>
            <div id="dataTable" style="font-size:0.75rem;"></div>
        </div>
        <div class="workspace">
            <div id="grid"></div>
        </div>
    </div>

    <div id="debugConsole">
        <div>> System Ready.</div>
    </div>

    <div id="modal">
        <div class="modal-box">
            <h3>Name Tag</h3>
            <input type="text" id="tagNameInput" placeholder="e.g. Start">
            <button onclick="saveTag()">Save</button>
        </div>
    </div>

    <script>
        // --- SAFE MODE LOGGING ---
        function log(msg, type='info') {
            const c = document.getElementById('debugConsole');
            const d = document.createElement('div');
            d.innerText = `> ${msg}`;
            if(type==='err') d.className = 'log-err';
            else d.className = 'log-info';
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
            console.log(msg);
        }

        window.onerror = function(msg, url, line) {
            log(`CRITICAL ERROR: ${msg} (Line ${line})`, 'err');
            return false;
        };

        // --- APP STATE ---
        const ROWS = 5;
        const COLS = 6;
        let program = [];
        let memory = {};
        let mode = 'edit';
        let tool = 'XIC';
        let running = false;
        let pendingCell = null;

        function init() {
            try {
                // Initialize empty grid
                for(let r=0; r<ROWS; r++) {
                    let row = [];
                    for(let c=0; c<COLS; c++) {
                        row.push({ type: 'EMPTY', tag: null, powered: false });
                    }
                    program.push(row);
                }
                render();
                log("Grid initialized successfully.");
            } catch(e) {
                log("Init failed: " + e.message, 'err');
            }
        }

        // --- TOOLS ---
        function setTool(t) {
            tool = t;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('t-'+(t==='DELETE'?'DEL':t)).classList.add('selected');
        }

        function setMode(m) {
            mode = m;
            document.getElementById('btnEdit').classList.toggle('active', m==='edit');
            document.getElementById('btnRun').classList.toggle('active', m==='run');
            
            if(m === 'run') {
                running = true;
                log("Starting Scan Cycle...");
                scan();
            } else {
                running = false;
                log("System Stopped.");
                // Clear power visuals
                program.forEach(r => r.forEach(c => c.powered = false));
                render();
            }
        }

        function clearProg() {
            if(confirm("Clear logic?")) location.reload();
        }

        // --- INTERACTION ---
        function cellClick(r, c) {
            try {
                if(mode === 'run') {
                    // Toggle Input
                    let cell = program[r][c];
                    if(cell.tag && (cell.type === 'XIC' || cell.type === 'XIO')) {
                        memory[cell.tag] = !memory[cell.tag];
                        log(`Toggled ${cell.tag} to ${memory[cell.tag]}`);
                        // No manual render, loop handles it
                    }
                    return;
                }

                // EDIT MODE
                if(tool === 'DELETE') {
                    program[r][c] = { type: 'EMPTY', tag: null, powered: false };
                    render();
                } else {
                    pendingCell = {r, c};
                    document.getElementById('tagNameInput').value = '';
                    document.getElementById('modal').style.display = 'flex';
                    document.getElementById('tagNameInput').focus();
                }
            } catch(e) {
                log("Click error: " + e.message, 'err');
            }
        }

        function saveTag() {
            let tag = document.getElementById('tagNameInput').value.trim();
            // FALLBACK: If user provides no name, generate one
            if(!tag) {
                tag = `Tag_${Date.now().toString().substr(-4)}`;
                log(`No name provided. Auto-generated: ${tag}`);
            }

            if(memory[tag] === undefined) memory[tag] = false;

            let {r, c} = pendingCell;
            program[r][c] = { type: tool, tag: tag, powered: false };
            
            document.getElementById('modal').style.display = 'none';
            render();
            updateData();
        }

        // --- RENDERING ---
        function render() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            program.forEach((row, r) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'rung';
                
                row.forEach((cell, c) => {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'cell';
                    if(cell.powered) cellDiv.classList.add('powered');
                    cellDiv.onclick = () => cellClick(r, c);

                    // Wire
                    const wire = document.createElement('div');
                    wire.className = 'wire-h';
                    cellDiv.appendChild(wire);

                    // Component
                    if(cell.type !== 'EMPTY') {
                        const sym = document.createElement('div');
                        sym.className = 'symbol';
                        sym.innerHTML = `<div class="tag-lbl">${cell.tag}</div>`;
                        
                        // Draw Symbol Text
                        let icon = '';
                        if(cell.type === 'XIC') icon = '||';
                        if(cell.type === 'XIO') icon = '|/|';
                        if(cell.type === 'OTE') {
                            icon = '( )';
                            // Visual feedback for OTE ON
                            if(memory[cell.tag]) sym.classList.add('on-coil');
                        }
                        
                        const txt = document.createElement('div');
                        txt.style.fontWeight = 'bold';
                        txt.innerText = icon;
                        sym.appendChild(txt);
                        cellDiv.appendChild(sym);
                    }
                    rowDiv.appendChild(cellDiv);
                });
                grid.appendChild(rowDiv);
            });
        }

        function updateData() {
            const dt = document.getElementById('dataTable');
            dt.innerHTML = '';
            for(let k in memory) {
                dt.innerHTML += `<div>${k}: <span style="color:${memory[k]?'#0f0':'#777'}">${memory[k]}</span></div>`;
            }
        }

        // --- LOGIC ENGINE ---
        function scan() {
            if(!running) return;

            try {
                // 1. Calculate Logic
                // Simple Scan: Row by Row, Left to Right
                program.forEach((row, r) => {
                    let hasPower = true; // Left rail always hot

                    row.forEach((cell, c) => {
                        // Visual: Input of this cell is hot?
                        if(hasPower) cell.powered = true;
                        else cell.powered = false;

                        // Logic: Does this cell pass power to the next?
                        if(cell.type === 'EMPTY') {
                            // Wire passes power
                        }
                        else if(cell.type === 'XIC') {
                            if(!memory[cell.tag]) hasPower = false;
                        }
                        else if(cell.type === 'XIO') {
                            if(memory[cell.tag]) hasPower = false;
                        }
                        else if(cell.type === 'OTE') {
                            // Coil is driven by current power
                            memory[cell.tag] = hasPower;
                        }
                    });
                });

                // 2. Update UI
                render();
                updateData();

                // 3. Loop
                requestAnimationFrame(scan);
                
            } catch(e) {
                running = false;
                log("CRITICAL SCAN ERROR: " + e.message, 'err');
                alert("Simulation Crashed. Check console.");
            }
        }

        init();
    </script>
</body>
</html>
